<?php
/**
 * Mage SMS - SMS notification & SMS marketing
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the BSD 3-Clause License
 * It is available through the world-wide-web at this URL:
 * http://opensource.org/licenses/BSD-3-Clause
 *
 * @category    TOPefekt
 * @package     TOPefekt_Magesms
 * @copyright   Copyright (c) 2012-2015 TOPefekt s.r.o. (http://www.mage-sms.com)
 * @license     http://opensource.org/licenses/BSD-3-Clause
 */
 class Topefekt_Magesms_Adminhtml_Magesms_OptoutController extends Topefekt_Magesms_Controller_Action { public function indexAction() { $this->_initAction(); $i8ee45e0018a32fb1a855b82624506e35789cc4d2 = $this->getLayout()->createBlock( 'Topefekt_Magesms_Block_Template', 'my_block_name_here2', array('template' => 'topefekt/magesms/optout.phtml') ); $i8ee45e0018a32fb1a855b82624506e35789cc4d2->setOptoutMarketing(Mage::getStoreConfig('magesms/optout/marketing')); $this->getLayout()->getBlock('content')->append($i8ee45e0018a32fb1a855b82624506e35789cc4d2); $this->renderLayout(); return $this; } public function saveAction() { $ic010a5d08128ec6abcd0a1a16cb1d8abe7bf2142 = Mage::getConfig()->getNode('default/config/optout')->sku; if ( $this->getRequest()->getPost() ) { $iacbd1c78463510856e506611fe14b5e1173581a6 = Mage::app()->getRequest(); Mage::app()->setCurrentStore(Mage_Core_Model_App::ADMIN_STORE_ID); $i69a1201e93806d55c970dfb18feec53d221ba37b = Mage::getModel('catalog/product')->loadByAttribute('sku', $ic010a5d08128ec6abcd0a1a16cb1d8abe7bf2142); if (!$i69a1201e93806d55c970dfb18feec53d221ba37b) { $i69a1201e93806d55c970dfb18feec53d221ba37b = Mage::getModel('catalog/product') ->setStoreId(0); $i777846b49037125c3bf5873d46a33ab5976c5a42 = Mage::getModel('catalog/product')->getResource()->getEntityType()->getDefaultAttributeSetId(); $i69a1201e93806d55c970dfb18feec53d221ba37b->setAttributeSetId($i777846b49037125c3bf5873d46a33ab5976c5a42); $i69a1201e93806d55c970dfb18feec53d221ba37b->setTypeId(Mage_Catalog_Model_Product_Type::TYPE_VIRTUAL); $i69a1201e93806d55c970dfb18feec53d221ba37b->setData('_edit_mode', true); $i69a1201e93806d55c970dfb18feec53d221ba37b->setSku($ic010a5d08128ec6abcd0a1a16cb1d8abe7bf2142); $i69a1201e93806d55c970dfb18feec53d221ba37b->setStatus(Mage_Catalog_Model_Product_Status::STATUS_ENABLED); $i69a1201e93806d55c970dfb18feec53d221ba37b->setTaxClassId(0); $i69a1201e93806d55c970dfb18feec53d221ba37b->setVisibility(Mage_Catalog_Model_Product_Visibility::VISIBILITY_NOT_VISIBLE); $i69a1201e93806d55c970dfb18feec53d221ba37b->setStockData(array( 'use_config_manage_stock' => 0, 'manage_stock' => 0, 'use_config_min_sale_qty' => 0, 'min_sale_qty' => 0, 'use_config_max_sale_qty' => 0, 'max_sale_qty' => 1, )); $if71cbed623a99cd5a1032d4d3388bfd486053db2 = array(); foreach (Mage::app()->getWebsites() as $i9fdb3b1e2e6984ebdd1220ec199279013c5483fc) { $if71cbed623a99cd5a1032d4d3388bfd486053db2[] = $i9fdb3b1e2e6984ebdd1220ec199279013c5483fc->getId(); } $i69a1201e93806d55c970dfb18feec53d221ba37b->setWebsiteIds($if71cbed623a99cd5a1032d4d3388bfd486053db2); $i69a1201e93806d55c970dfb18feec53d221ba37b->setCreatedAt(strtotime('now')); $i69a1201e93806d55c970dfb18feec53d221ba37b->setDescription($iacbd1c78463510856e506611fe14b5e1173581a6->getPost('name')); $i69a1201e93806d55c970dfb18feec53d221ba37b->setShortDescription($iacbd1c78463510856e506611fe14b5e1173581a6->getPost('name')); $i2bd9743336318d0e14be0600c9129730279505dd = array_values($iacbd1c78463510856e506611fe14b5e1173581a6->getPost('name')); $i69a1201e93806d55c970dfb18feec53d221ba37b->setName($i2bd9743336318d0e14be0600c9129730279505dd[0]); $i69a1201e93806d55c970dfb18feec53d221ba37b->setPrice(0); $ia021b43e6045d8140052e6c3c684787a27e4bbe5 = Mage::getBaseDir('media'); if (file_exists($ia021b43e6045d8140052e6c3c684787a27e4bbe5.'/magesms/sms.png')) { $i1babd2991da6b9dfe1f546b773f6f35cec746fff = array ('thumbnail', 'small_image', 'image'); $i69a1201e93806d55c970dfb18feec53d221ba37b->addImageToMediaGallery($ia021b43e6045d8140052e6c3c684787a27e4bbe5.'/magesms/sms.png', $i1babd2991da6b9dfe1f546b773f6f35cec746fff, false, false); } $i69a1201e93806d55c970dfb18feec53d221ba37b->save(); Mage::getModel('catalogrule/rule')->applyAllRulesToProduct($i69a1201e93806d55c970dfb18feec53d221ba37b->getId()); foreach(Mage::app()->getStores(false) as $i7079b107a03c03d74ad14b853dad74b85b2d25d1) { Mage::getModel('catalog/product_status')->updateProductStatus($i69a1201e93806d55c970dfb18feec53d221ba37b->getId(), $i7079b107a03c03d74ad14b853dad74b85b2d25d1->getId(), Mage_Catalog_Model_Product_Status::STATUS_DISABLED); } } else { } $i8171218dd25ff7f2de2e1c0d8733bda70b607d79 = $iacbd1c78463510856e506611fe14b5e1173581a6->getPost('website', 0); $i712821c3a64ae4a252ded9f3deaaddb6e942d985 = $iacbd1c78463510856e506611fe14b5e1173581a6->getPost('status', 0) ? Mage_Catalog_Model_Product_Status::STATUS_ENABLED : Mage_Catalog_Model_Product_Status::STATUS_DISABLED; $ie7d1f3c0ab09749c63a4d4213221b59ce80ea45c = $iacbd1c78463510856e506611fe14b5e1173581a6->getPost('name', array()); $ib8129b89cda7dae2cfe1b114353de8ba2385974e = $iacbd1c78463510856e506611fe14b5e1173581a6->getPost('auto', 1); foreach(Mage::app()->getWebsite($i8171218dd25ff7f2de2e1c0d8733bda70b607d79)->getStoreIds() as $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66) { Mage::getModel('catalog/product_status')->updateProductStatus($i69a1201e93806d55c970dfb18feec53d221ba37b->getId(), $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66, $i712821c3a64ae4a252ded9f3deaaddb6e942d985); $i69a1201e93806d55c970dfb18feec53d221ba37b->load($i69a1201e93806d55c970dfb18feec53d221ba37b->getId()); $i69a1201e93806d55c970dfb18feec53d221ba37b->setStoreId($i3bf172bc34c83f4a18624b192bc0bd7c4d647a66); $i69a1201e93806d55c970dfb18feec53d221ba37b->setPrice($iacbd1c78463510856e506611fe14b5e1173581a6->getPost('price')); if (isset($ie7d1f3c0ab09749c63a4d4213221b59ce80ea45c[$i3bf172bc34c83f4a18624b192bc0bd7c4d647a66])) $i69a1201e93806d55c970dfb18feec53d221ba37b->setName($ie7d1f3c0ab09749c63a4d4213221b59ce80ea45c[$i3bf172bc34c83f4a18624b192bc0bd7c4d647a66]); $i69a1201e93806d55c970dfb18feec53d221ba37b->save(); Mage::getSingleton('catalog/product_action')->updateAttributes(array($i69a1201e93806d55c970dfb18feec53d221ba37b->getId()), array('magesms_optout' => $ib8129b89cda7dae2cfe1b114353de8ba2385974e), $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66); Mage::getSingleton('catalog/product_action')->updateAttributes(array($i69a1201e93806d55c970dfb18feec53d221ba37b->getId()), array('magesms_optout' => 1), 0); } Mage::getSingleton('adminhtml/session')->addSuccess(Mage::helper('magesms')->__('Setting of the SMS opt-out feature was successfully changed')); } $this->_redirect('*/*/index', array('_fragment' => $i8171218dd25ff7f2de2e1c0d8733bda70b607d79)); } public function saveOptoutMarketingAction() { $iacbd1c78463510856e506611fe14b5e1173581a6 = Mage::app()->getRequest(); Mage::getModel('core/config')->saveConfig('magesms/optout/marketing', $iacbd1c78463510856e506611fe14b5e1173581a6->getPost('status')); Mage::getConfig()->reinit(); $this->_redirect('*/*/index'); } protected function _initAction() { parent::_initAction(); $this->_setActiveMenu('magesms/purchasecredit') ->_title(Mage::helper('magesms')->__('SMS opt-out')); ; return $this; } } 