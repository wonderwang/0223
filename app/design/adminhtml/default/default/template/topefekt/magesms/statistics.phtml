<?php
/**
 * Mage SMS - SMS notification & SMS marketing
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the BSD 3-Clause License
 * It is available through the world-wide-web at this URL:
 * http://opensource.org/licenses/BSD-3-Clause
 *
 * @category    TOPefekt
 * @package     TOPefekt_Magesms
 * @copyright   Copyright (c) 2012-2015 TOPefekt s.r.o. (http://www.mage-sms.com)
 * @license     http://opensource.org/licenses/BSD-3-Clause
 */
?><?php $user = $this->profile->user; ?><?php $lang = $this->profile->lang; ?><?php $type = array( 1 => Mage::helper('magesms')->__(' admin sms'), 2 => Mage::helper('magesms')->__(' customer sms'), 3 => Mage::helper('magesms')->__(' marketing sms'), 4 => Mage::helper('magesms')->__(' simple sms') ); ?><h2><?php echo Mage::helper('magesms')->__('Statistics'); ?></h2><div id="magesms"><div class="entry-edit"><div class="entry-edit-head"><h4 class="icon-head fieldset-legend head-account"><img src="<?php echo Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_MEDIA).'magesms/AdminTools.gif'; ?>" alt="" /> <?php echo Mage::helper('magesms')->__('Statistics'); ?></h4></div><div class="fieldset grid"><form id="magesms_filter" action="<?php echo Mage::getUrl('*/*/filter') ?>" method="post"><input name="form_key" type="hidden" value="<?php echo Mage::getSingleton('core/session')->getFormKey() ?>" /><div class="margin-form" style="text-align: center"><label for="datefrom"><?php echo Mage::helper('magesms')->__('Date from:'); ?></label><input type="text" style="width: 100px;" class="input-text" value="<?php echo $this->getFilterData('datefrom') ? $this->getFilterData('datefrom') : Mage::app()->getLocale()->date(Mage::getModel('core/date')->timestamp(), null, null, false)->toString(Mage::app()->getLocale()->getDateFormat(Mage_Core_Model_Locale::FORMAT_TYPE_SHORT)); ?>" id="datefrom" name="datefrom"/><img style="cursor:pointer" title="<?php echo Mage::helper('magesms')->__('Calendar'); ?>" id="date_select_from" class="v-middle" alt="" src="<?php echo $this->getSkinUrl("images/grid-cal.gif");?> "/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label for="dateto"><?php echo Mage::helper('magesms')->__('to: '); ?></label><input type="text" style="width: 100px;" class="input-text" value="<?php echo $this->getFilterData('dateto') ? $this->getFilterData('dateto') : Mage::app()->getLocale()->date(Mage::getModel('core/date')->timestamp(), null, null, false)->toString(Mage::app()->getLocale()->getDateFormat(Mage_Core_Model_Locale::FORMAT_TYPE_SHORT)); ?>" id="dateto" name="dateto"/><img style="cursor:pointer" title="<?php echo Mage::helper('magesms')->__('Calendar'); ?>" id="date_select_to" class="v-middle" alt="" src="<?php echo $this->getSkinUrl("images/grid-cal.gif");?> "/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<select name="status" id="status"><option value=""><?php echo Mage::helper('magesms')->__('Status'); ?></option><?php foreach( Mage::getSingleton('magesms/sms')->status() as $id=>$stat ): ?><option value="<?php echo $id; ?>" <?php echo $id == $this->getFilterData('status') ? 'selected' : ''; ?>><?php echo $stat->name; ?></option><?php endforeach; ?></select><input type="hidden" name="eshopsms1" value="0" />&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" name="eshopsms1" id="eshopsms1" value="1" <?php echo $this->getRequest()->getParam('eshopsms1') == null || $this->getRequest()->getParam('eshopsms1') == 1 ? 'checked' : ''; ?> /><label for="eshopsms1"><?php echo Mage::helper('magesms')->__(' admin sms'); ?></label><input type="hidden" name="eshopsms" value="0" />&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" name="eshopsms" id="eshopsms" value="1" <?php echo $this->getRequest()->getParam('eshopsms') == null || $this->getRequest()->getParam('eshopsms') == 1 ? 'checked' : ''; ?> /><label for="eshopsms"><?php echo Mage::helper('magesms')->__(' customer sms'); ?></label><input type="hidden" name="bulksms" value="0" />&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" name="bulksms" id="bulksms" value="1" <?php echo $this->getRequest()->getParam('bulksms') == null || $this->getRequest()->getParam('bulksms') == 1 ? 'checked' : ''; ?> /><label for="bulksms"><?php echo Mage::helper('magesms')->__(' marketing sms'); ?></label><input type="hidden" name="bulksms2" value="0" />&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" name="bulksms2" id="bulksms2" value="1" <?php echo $this->getRequest()->getParam('bulksms2') == null || $this->getRequest()->getParam('bulksms2') == 1 ? 'checked' : ''; ?> /><label for="bulksms2"><?php echo Mage::helper('magesms')->__(' simple sms'); ?></label>&nbsp;&nbsp;&nbsp;&nbsp;<input type="submit" value="<?php echo Mage::helper('magesms')->__('Show'); ?>" class="form-button" /></div><script type="text/javascript">//<![CDATA[
Calendar.setup({inputField: "datefrom",ifFormat: "<?php echo Mage::app()->getLocale()->getDateStrFormat(Mage_Core_Model_Locale::FORMAT_TYPE_SHORT); ?>",showsTime: false,button: "date_select_from",align: "Bl",singleClick : true});Calendar.setup({inputField: "dateto",ifFormat: "<?php echo Mage::app()->getLocale()->getDateStrFormat(Mage_Core_Model_Locale::FORMAT_TYPE_SHORT); ?>",showsTime: false,button: "date_select_to",align: "Bl",singleClick : true});
//]]></script></form></div></div><?php $history = Mage::getSingleton('magesms/smshistory')->getCollection(); $requestData = Mage::helper('magesms')->filterDates($this->getFilterData()->getData(), array('datefrom', 'dateto')); $from = !empty($requestData['datefrom']) ? $requestData['datefrom'] : date('Y-m-d', Mage::getModel('core/date')->timestamp()); $to = !empty($requestData['dateto']) ? $requestData['dateto'] : date('Y-m-d', Mage::getModel('core/date')->timestamp()); $history->addFieldToFilter('date', array('from' => $from.' 00:00:00')) ->addFieldToFilter('date', array('to' => $to.' 23:59:59')); if (($_status = $this->getFilterData('status'))) { $history->addFieldToFilter('status', $_status); } $notin = array(); if ($this->getRequest()->getParam('eshopsms', 1) != 1) $notin[] = 2; if ($this->getRequest()->getParam('eshopsms1', 1) != 1) $notin[] = 1; if ($this->getRequest()->getParam('bulksms', 1) != 1) $notin[] = 3; if ($this->getRequest()->getParam('bulksms2', 1) != 1) $notin[] = 4; if (count($notin)) { $history->addFieldToFilter('type', array('nin' => $notin)); } $count = $history->getSize(); if ($count): $output = array('status' => array(), 'type' => array()); foreach($history as $_obj) { if (!isset($output['type'][$_obj->getType()])) $output['type'][$_obj->getType()] = 0; $output['type'][$_obj->getType()]++; if ($_obj->getStatus() != Topefekt_Magesms_Model_Sms::ERROR) { if (!isset($output['status'][Mage::getSingleton('magesms/sms')->status($_obj->getStatus())->name])) $output['status'][Mage::getSingleton('magesms/sms')->status($_obj->getStatus())->name] = 0; $output['status'][Mage::getSingleton('magesms/sms')->status($_obj->getStatus())->name]++; } else { if (!isset($output['status'][Mage::getSingleton('magesms/sms')->status($_obj->getStatus())->name.' - '.$_obj->getNote()])) $output['status'][Mage::getSingleton('magesms/sms')->status($_obj->getStatus())->name.' - '.$_obj->getNote()] = 0; $output['status'][Mage::getSingleton('magesms/sms')->status($_obj->getStatus())->name.' - '.$_obj->getNote()]++; } } ?><div class="entry-edit"><div class="entry-edit-head"><h4 class="icon-head fieldset-legend head-account"><img src="<?php echo Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_MEDIA).'magesms/AdminCatalog.gif'; ?>" alt="" /><?php echo Mage::helper('magesms')->__('Total sms:').' '.$count; ?></h4></div><div class="fieldset grid"><script type="text/javascript" src="https://www.google.com/jsapi"></script><script type="text/javascript">google.load("visualization", "1", {packages:["corechart"]});google.setOnLoadCallback(drawChart);function drawChart() {var dataStatus = google.visualization.arrayToDataTable([['SMS', 'Count'],<?php foreach($output['status'] as $key=>$val): ?>['<?php echo $key; ?>', <?php echo $val; ?>],<?php endforeach; ?>]);var optionsStatus = {title: '<?php echo Mage::helper('magesms')->__('Status'); ?>',backgroundColor: '#fdfdfd',pieSliceText: 'value',};var chartStatus = new google.visualization.PieChart(document.getElementById('Status'));chartStatus.draw(dataStatus, optionsStatus);var dataType = google.visualization.arrayToDataTable([['SMS', 'Count'],<?php foreach($output['type'] as $key=>$val): ?>['<?php echo $type[$key]; ?>', <?php echo $val; ?>],<?php endforeach; ?>]);var optionsType = {title: '<?php echo Mage::helper('magesms')->__('Type'); ?>',backgroundColor: '#fdfdfd',pieSliceText: 'value',};var chartType = new google.visualization.PieChart(document.getElementById('Type'));chartType.draw(dataType, optionsType);}</script><div id="Type" style="width: 49%; min-width: 630px; height: 400px; display: inline-block;"></div><div id="Status" style="width: 49%; min-width: 630px; height: 400px; display: inline-block;"></div></div></div><?php else: ?><div><?php echo Mage::helper('magesms')->__('Total SMS: 0'); ?></div><?php endif; ?></div>