<?php
/**
 * Mage SMS - SMS notification & SMS marketing
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the BSD 3-Clause License
 * It is available through the world-wide-web at this URL:
 * http://opensource.org/licenses/BSD-3-Clause
 *
 * @category    TOPefekt
 * @package     TOPefekt_Magesms
 * @copyright   Copyright (c) 2012-2015 TOPefekt s.r.o. (http://www.mage-sms.com)
 * @license     http://opensource.org/licenses/BSD-3-Clause
 */
?><?php $user = $this->profile->user; ?><?php $lang = $this->profile->lang; ?><?php $type = array( 1 => Mage::helper('magesms')->__(' admin sms'), 2 => Mage::helper('magesms')->__(' customer sms'), 3 => Mage::helper('magesms')->__(' marketing sms'), 4 => Mage::helper('magesms')->__(' simple sms') ); ?><div style="float: right;"><form action="<?php echo $this->getUrl('*/*/delete') ?>" method="post"><input name="form_key" type="hidden" value="<?php echo Mage::getSingleton('core/session')->getFormKey() ?>" /><input type="submit" value="<?php echo Mage::helper('magesms')->__('Delete history'); ?>" onclick="return confirm('<?php echo Mage::helper('magesms')->__('Are you sure to delete SMS history?'); ?>');" class="form-button" /></form></div><h2><?php echo Mage::helper('magesms')->__('SMS History'); ?></h2><p><?php echo Mage::helper('magesms')->__('History of sent SMS from SMS module.'); ?></p><div id="magesms"><div class="entry-edit"><div class="entry-edit-head"><h4 class="icon-head fieldset-legend head-account"><img src="<?php echo Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_MEDIA).'magesms/AdminTools.gif'; ?>" alt="" /> <?php echo Mage::helper('magesms')->__('SMS History'); ?></h4></div><div class="fieldset grid"><form id="magesms_filter" action="<?php echo Mage::getUrl('*/*/filter') ?>" method="post"><input name="form_key" type="hidden" value="<?php echo Mage::getSingleton('core/session')->getFormKey() ?>" /><?php $history = Mage::getSingleton('magesms/smshistory')->getCollection() ->setOrder('date', 'ASC'); $history->getSelect()->limit(1); if ($history->count()) $rokmin = substr($history->getFirstItem()->getDate(), 0, 4); else $rokmin = date('Y'); $roky = array(); for(; $rokmin <= date('Y'); $rokmin++) $roky[] = $rokmin; ?><div class="margin-form" style="text-align: center"><select name="rok" id="rok"><option value=""><?php echo Mage::helper('magesms')->__('year'); ?></option><?php foreach( $roky as $rok ): ?><option value="<?php echo $rok; ?>" <?php echo $rok == $this->getRequest()->getParam('rok', date('Y')) ? 'selected' : ''; ?>><?php echo $rok; ?></option><?php endforeach; ?></select><select name="mesic" id="mesic"><option value=""><?php echo Mage::helper('magesms')->__('month'); ?></option><?php for( $mesic=1; $mesic<=12; $mesic++ ): ?><option value="<?php echo $mesic; ?>" <?php echo $mesic == $this->getRequest()->getParam('mesic', date('m')) ? 'selected' : ''; ?>><?php echo $mesic; ?></option><?php endfor; ?></select><select name="den" id="den"><option value=""><?php echo Mage::helper('magesms')->__('day'); ?></option><?php for( $den=1; $den<=31; $den++ ): ?><option value="<?php echo $den; ?>" <?php echo $den == $this->getRequest()->getParam('den') ? 'selected' : ''; ?>><?php echo sprintf('%02d', $den); ?></option><?php endfor; ?></select><select name="status" id="status"><option value=""><?php echo Mage::helper('magesms')->__('Status'); ?></option><?php foreach( Mage::getSingleton('magesms/sms')->status() as $id=>$stat ): ?><option value="<?php echo $id; ?>" <?php echo $id == $this->getRequest()->getParam('status') ? 'selected' : ''; ?>><?php echo $stat->name; ?></option><?php endforeach; ?></select><input type="hidden" name="eshopsms1" value="0" />&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" name="eshopsms1" id="eshopsms1" value="1" <?php echo $this->getRequest()->getParam('eshopsms1') == null || $this->getRequest()->getParam('eshopsms1') == 1 ? 'checked' : ''; ?> /><label for="eshopsms1"><?php echo Mage::helper('magesms')->__(' admin sms'); ?></label><input type="hidden" name="eshopsms" value="0" />&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" name="eshopsms" id="eshopsms" value="1" <?php echo $this->getRequest()->getParam('eshopsms') == null || $this->getRequest()->getParam('eshopsms') == 1 ? 'checked' : ''; ?> /><label for="eshopsms"><?php echo Mage::helper('magesms')->__(' customer sms'); ?></label><input type="hidden" name="bulksms" value="0" />&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" name="bulksms" id="bulksms" value="1" <?php echo $this->getRequest()->getParam('bulksms') == null || $this->getRequest()->getParam('bulksms') == 1 ? 'checked' : ''; ?> /><label for="bulksms"><?php echo Mage::helper('magesms')->__(' marketing sms'); ?></label><input type="hidden" name="bulksms2" value="0" />&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" name="bulksms2" id="bulksms2" value="1" <?php echo $this->getRequest()->getParam('bulksms2') == null || $this->getRequest()->getParam('bulksms2') == 1 ? 'checked' : ''; ?> /><label for="bulksms2"><?php echo Mage::helper('magesms')->__(' simple sms'); ?></label>&nbsp;&nbsp;&nbsp;&nbsp;<input type="submit" value="<?php echo Mage::helper('magesms')->__('Show'); ?>" class="form-button" /></div></form></div></div><?php $pageSize = 50; $page = $this->getRequest()->getParam('page', 1); $format = Mage::app()->getLocale()->getDateTimeFormat(Mage_Core_Model_Locale::FORMAT_TYPE_MEDIUM); $history = Mage::getSingleton('magesms/smshistory')->getCollection()->setOrder('date', 'DESC'); $rok = $this->getRequest()->getParam('rok', date('Y')); $mesic = $this->getRequest()->getParam('mesic', date('m')); $den = $this->getRequest()->getParam('den'); if ($den) { $history->getSelect()->where("`date` LIKE ?", sprintf("%04d-%02d-%02d%%", $rok, $mesic, $den)); } else { $history->getSelect()->where("`date` LIKE ?", sprintf("%04d-%02d-%%", $rok, $mesic)); } if (($_status = $this->getRequest()->getParam('status'))) { $history->addFilter('status', $_status); } $notin = array(); if ($this->getRequest()->getParam('eshopsms', 1) != 1) $notin[] = 2; if ($this->getRequest()->getParam('eshopsms1', 1) != 1) $notin[] = 1; if ($this->getRequest()->getParam('bulksms', 1) != 1) $notin[] = 3; if ($this->getRequest()->getParam('bulksms2', 1) != 1) $notin[] = 4; if (count($notin)) { $history->getSelect()->where("`type` NOT IN (?)", $notin); } $history->setPageSize($pageSize); $history->setCurPage($page); if ($history->getSize()): $from = ($page-1) * $pageSize + 1; $to = ($page-1) * $pageSize + $pageSize; if ($to > $history->getSize()) $to = $history->getSize(); $this->getRequest()->setParam('page', null); ?><div class="entry-edit"><div class="entry-edit-head"><h4 class="icon-head fieldset-legend head-account"><img src="<?php echo Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_MEDIA).'magesms/AdminCatalog.gif'; ?>" alt="" /><?php echo Mage::helper('magesms')->__('Search results ').' '.$from.' - '.$to.Mage::helper('magesms')->__(' of ').$history->getSize().' '.Mage::helper('magesms')->__('SMS'); ?></h4></div><div class="fieldset grid"><table class="actions"><tr><td class="pager"><?php echo $this->__('Page') ?><?php $_curPage = $history->getCurPage() ?><?php $_lastPage = $history->getLastPageNumber() ?><?php if($_curPage>1): ?><a href="<?php echo Mage::helper("adminhtml")->getUrl('*/*/', $this->getRequest()->getParams()+array('page' => $_curPage-1)); ?>" title="<?php echo $this->__('Previous') ?>"><img src="<?php echo $this->getSkinUrl('images/pager_arrow_left.gif') ?>" alt="Go to Previous page" class="arrow"/></a><?php else: ?><img src="<?php echo $this->getSkinUrl('images/pager_arrow_left_off.gif') ?>" alt="Go to Previous page" class="arrow"/><?php endif; ?><input type="text" name="curPage" readonly value="<?php echo $_curPage ?>" class="input-text page" /><?php if($_curPage < $_lastPage): ?><a href="<?php echo Mage::helper("adminhtml")->getUrl('*/*/', $this->getRequest()->getParams()+array('page' => $_curPage+1)); ?>" title="<?php echo $this->__('Next') ?>"><img src="<?php echo $this->getSkinUrl('images/pager_arrow_right.gif') ?>" alt="Go to Next page" class="arrow"/></a><?php else: ?><img src="<?php echo $this->getSkinUrl('images/pager_arrow_right_off.gif') ?>" alt="Go to Previous page" class="arrow"/><?php endif; ?></td></tr></table><table class="data"><tr class="headings"><th><?php echo Mage::helper('magesms')->__('Number'); ?></th><th><?php echo Mage::helper('magesms')->__('Recipient'); ?></th><th><?php echo Mage::helper('magesms')->__('SMS subject'); ?></th><th class="a-left"><?php echo Mage::helper('magesms')->__('Date'); ?></th><th><?php echo Mage::helper('magesms')->__('Type'); ?></th><th class="a-center"><?php echo Mage::helper('magesms')->__('Status'); ?></th></tr><?php $even = 1; foreach($history as $_obj): if ($even) $even = 0; else $even = 1;?><tr id="hist_<?php echo $_obj->getId(); ?>" class="hover <?php if ($even) echo 'even'?>"><td><span class="img"><img class="toggle" src="<?php echo Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_MEDIA).'magesms/i_plus.gif'; ?>"></span><span class="img" style="display:none"><img class="toggle" src="<?php echo Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_MEDIA).'magesms/i_minus.gif'; ?>"></span><?php echo $_obj->getNumber(); ?></td><td><?php if ($_obj->getCustomerId()): ?><?php $customer = Mage::getModel('customer/customer')->load($_obj->getCustomerId()); ?><?php if ($customer->getId()): ?><a href="<?php echo Mage::helper("adminhtml")->getUrl('*/customer/edit', array('id' => $_obj->getCustomerId())); ?>" target="magesms_popup_customer" title="<?php echo Mage::helper('magesms')->__('Display customer detail'); ?>"><?php echo $customer->getFirstname(); ?> <?php echo $customer->getLastname(); ?></a><?php else: ?><?php echo Mage::helper('magesms')->moreText($_obj->getRecipient(), 16, 25); ?><?php endif; ?><?php elseif ($_obj->getAdminId()): ?><?php $admin = Mage::getModel('magesms/admins')->load($_obj->getAdminId()); ?><?php if ($admin->getId()): ?><?php echo $admin->getName(); ?><?php else: ?><?php echo Mage::helper('magesms')->moreText($_obj->getRecipient(), 16, 25); ?><?php endif; ?><?php else: ?><?php echo ($recipient = Mage::helper('magesms')->moreText($_obj->getRecipient(), 16, 25)) ? $recipient: '-' ?><?php endif; ?></td><td><?php echo ($subject = Mage::helper('magesms')->moreText($_obj->getSubject(), 16, 25)) ? $subject : '-'; ?></td><td><?php echo Mage::helper('core')->formatDate($_obj->getDate(), 'medium', true); ?></td><td><?php echo $type[$_obj->getType()]; ?></td><td class="a-center"><img src="<?php echo Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_MEDIA).'magesms/'.Mage::getSingleton('magesms/sms')->status($_obj->getStatus())->icon; ?>" title="<?php echo Mage::getSingleton('magesms/sms')->status($_obj->getStatus())->name.(($note=$_obj->getNote()) && ($_obj->getStatus() == Topefekt_Magesms_Model_Sms::ERROR || $_obj->getStatus() == Topefekt_Magesms_Model_Sms::SCHEDULED) ? " - $note" : '') ; ?>" /></td></tr><tr id="histd_<?php echo $_obj->getId(); ?>" class="<?php if ($even) echo 'even'?>" style="display:none"><td colspan="6"><b><?php echo Mage::helper('magesms')->__('Text:'); ?></b><br /><?php echo $_obj->getText(); ?><br /><br /><b><?php echo Mage::helper('magesms')->__('SMS price in credits:'); ?></b> <?php echo $_obj->getPrice(); ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<?php if ($_obj->getPrice() > 0): ?><b><?php echo Mage::helper('magesms')->__('Credit balance:'); ?></b> <?php echo $_obj->getCredit(); ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<?php endif; ?><b><?php echo Mage::helper('magesms')->__('Total SMS:'); ?></b> <?php echo $_obj->getTotal(); ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><?php echo Mage::helper('magesms')->__('Unicode:'); ?></b> <?php echo $_obj->getUnicode() ? Mage::helper('magesms')->__('yes') : Mage::helper('magesms')->__('no'); ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><?php echo Mage::helper('magesms')->__('senderID:'); ?></b><?php if ($_obj->getSender() && preg_match("/^([0-9])*$/", $_obj->getSender(), $matches)): ?>+<?php echo $_obj->getSender(); ?><?php elseif ($_obj->getSender()): ?><?php echo $_obj->getSender(); ?><?php else: ?><?php echo Mage::helper('magesms')->__('system number'); ?><?php endif; ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<?php if ($_obj->getSmsid()): ?><br /><b><?php echo Mage::helper('magesms')->__('smsID:'); ?></b> <?php echo $_obj->getSmsid(); ?><?php endif; ?></td></tr><?php endforeach; ?></table><table class="actions"><tr><td class="pager"><?php echo $this->__('Page') ?><?php $_curPage = $history->getCurPage() ?><?php $_lastPage = $history->getLastPageNumber() ?><?php if($_curPage>1): ?><a href="<?php echo Mage::helper("adminhtml")->getUrl('*/*/', $this->getRequest()->getParams()+array('page' => $_curPage-1)); ?>" title="<?php echo $this->__('Previous') ?>"><img src="<?php echo $this->getSkinUrl('images/pager_arrow_left.gif') ?>" alt="Go to Previous page" class="arrow"/></a><?php else: ?><img src="<?php echo $this->getSkinUrl('images/pager_arrow_left_off.gif') ?>" alt="Go to Previous page" class="arrow"/><?php endif; ?><input type="text" name="curPage" readonly value="<?php echo $_curPage ?>" class="input-text page" /><?php if($_curPage < $_lastPage): ?><a href="<?php echo Mage::helper("adminhtml")->getUrl('*/*/', $this->getRequest()->getParams()+array('page' => $_curPage+1)); ?>" title="<?php echo $this->__('Next') ?>"><img src="<?php echo $this->getSkinUrl('images/pager_arrow_right.gif') ?>" alt="Go to Next page" class="arrow"/></a><?php else: ?><img src="<?php echo $this->getSkinUrl('images/pager_arrow_right_off.gif') ?>" alt="Go to Previous page" class="arrow"/><?php endif; ?></td></tr></table></div></div><script type="text/javascript">//<![CDATA[
Event.observe(window, "load", function(){var gridData = document.getElementById('magesms');var tr_array = gridData.getElementsByTagName('tr');for (var i=0, len=tr_array.length; i < len; i++) {if (tr_array[i].className.indexOf('hover') !== -1) {tr_array[i].onmouseover = function() {this.className = this.className + ' on-mouse';};tr_array[i].onmouseout = function() {this.className = this.className.replace(' on-mouse', '');};tr_array[i].onclick = function() {var arr = this.id.split('_');var next = document.getElementById('histd_'+arr[1]);if (next.style.display == 'none') {next.style.display = 'table-row';} else {next.style.display = 'none';}var img = this.getElementsByClassName('img');if (img[0].style.display == 'none') {img[0].style.display = 'inline';} else {img[0].style.display = 'none';}if (img[1].style.display == 'none') {img[1].style.display = 'inline';} else {img[1].style.display = 'none';}};}}});
//]]></script><?php else: ?><div><?php echo Mage::helper('magesms')->__('Total SMS: 0'); ?></div><?php endif; ?></div>